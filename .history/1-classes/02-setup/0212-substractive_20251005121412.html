<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Hyperphone — Trigger‑First Wireframe</title>
<style>
  :root{ --bg:#000; --wire:#fff; --fill:rgba(255,255,255,.66); }
  html,body{height:100%;margin:0;background:var(--bg);color:transparent;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace;overflow:hidden;-webkit-user-select:none;user-select:none}

  header{display:flex;gap:8px;align-items:center;padding:8px;background:transparent}
  .chip,.btn{background:transparent;color:transparent;padding:0;border:none;cursor:pointer;position:relative}
  .chip{width:20px;height:20px}
  .btn{width:28px;height:28px}
  .chip::after,.btn::after{content:"";position:absolute;inset:0;border:1px solid var(--wire)}
  .chip[aria-pressed="true"]::after{box-shadow:0 0 0 2px var(--wire) inset}

  /* Flex fullscreen grid */
  .grid{display:flex;flex-wrap:wrap;gap:10px;padding:10px;height:calc(100% - 44px);align-content:stretch}

  /* TRIGGER is the *only* element that has a border */
  .trigger{position:relative;display:flex;flex-direction:column;justify-content:flex-start;align-items:stretch;width:160px;height:160px;background:transparent}
  .trigger::after{content:"";position:absolute;inset:0;border:1px solid var(--wire)}
  .trigger.active::after{box-shadow:0 0 12px var(--wire),0 0 0 2px var(--wire) inset}

  /* Slider rack INSIDE each trigger (upper area) */
  .rack{display:flex;gap:6px;padding:6px 6px 0 6px}
  .vslider{--val:0%;position:relative;width:28px;height:50px} /* no borders here */
  .vslider .fill{position:absolute;left:0;bottom:0;width:100%;height:var(--val);background:var(--fill)}

  /* Touch/press area occupies the rest */
  .pad{flex:1 1 auto}

  /* Right-edge VU line */
  #vuLine{position:fixed;top:0;right:0;width:1px;height:100vh;background:transparent;z-index:9999}
  #vuLine .fill{position:absolute;bottom:0;right:0;width:1px;height:100%;background:#00ff00;transform-origin:bottom;transform:scaleY(0)}
</style>
</head>
<body>
  <header>
    <div id="divisionBar" title="ArrowLeft/ArrowRight — divisions"></div>
    <button id="fullscreenBtn" class="btn" title="Toggle Fullscreen"></button>
  </header>
  <main class="grid" id="grid" title="Workspace"></main>
  <div id="vuLine"><div class="fill"></div></div>

<script>
/*************** AUDIO CORE ***************/
let audioCtx, masterGain, analyser; let startedOnce=false;
async function ensureAudio(){
  if(audioCtx && audioCtx.state!=='closed'){ if(audioCtx.state==='suspended') await audioCtx.resume(); return; }
  audioCtx=new (window.AudioContext||window.webkitAudioContext)({latencyHint:'interactive'});
  masterGain=audioCtx.createGain(); masterGain.gain.value=0.9;
  analyser=audioCtx.createAnalyser(); analyser.fftSize=2048;
  masterGain.connect(analyser).connect(audioCtx.destination);
}
function noiseBuf(ctx){ const len=ctx.sampleRate*2, b=ctx.createBuffer(2,len,ctx.sampleRate); for(let c=0;c<2;c++){const d=b.getChannelData(c); for(let i=0;i<len;i++) d[i]=Math.random()*2-1;} return b; }
function makeNoise(){ const s=audioCtx.createBufferSource(); s.buffer=noiseBuf(audioCtx); s.loop=true; const g=audioCtx.createGain(); g.gain.value=1; s.connect(g); return {src:s,out:g}; }
function biq({type='lowpass',freq=1200,Q=0.0001}){ const f=audioCtx.createBiquadFilter(); f.type=type; f.frequency.value=freq; f.Q.value=Q; return f; }
function adsr({A=.01,D=.1,S=.7,R=.2}){ const v=audioCtx.createGain(); v.gain.value=0; return {node:v, on(){const t=audioCtx.currentTime; v.gain.cancelScheduledValues(t); v.gain.setValueAtTime(v.gain.value,t); v.gain.linearRampToValueAtTime(1,t+A); v.gain.linearRampToValueAtTime(S,t+A+D);}, off(){const t=audioCtx.currentTime; v.gain.cancelScheduledValues(t); v.gain.setValueAtTime(v.gain.value,t); v.gain.linearRampToValueAtTime(0,t+R);} }; }

/*************** GLOBAL VU ***************/
function startVU(){ if(!analyser) return; if(startedOnce) return; startedOnce=true; const fill=document.querySelector('#vuLine .fill'); const data=new Uint8Array(analyser.fftSize); (function loop(){ analyser.getByteTimeDomainData(data); let sum=0; for(let i=0;i<data.length;i++){ const v=(data[i]-128)/128; sum+=v*v; } const rms=Math.sqrt(sum/data.length); fill.style.transform=`scaleY(${Math.min(1,rms*2.5)})`; requestAnimationFrame(loop); })(); }

/*************** LAYOUT ***************/
const grid=document.getElementById('grid');
const divisionBar=document.getElementById('divisionBar');
const fullscreenBtn=document.getElementById('fullscreenBtn');
let divisions=3; // default

// build chips
for(let n=1;n<=8;n++){ const b=document.createElement('button'); b.className='chip'; b.title=`Divisions ${n}`; b.setAttribute('aria-pressed', String(n===divisions)); b.onclick=()=>setDivisions(n); divisionBar.appendChild(b); }

function setDivisions(n){
  divisions=Math.max(1,Math.min(8,n));
  [...divisionBar.children].forEach((c,i)=>c.setAttribute('aria-pressed', String(i+1===divisions)));
  render();
  // sizing
  const children=[...grid.children]; const cols=Math.min(4,divisions);
  children.forEach((el,i)=>{ el.style.order=i; el.style.flex="1 1 calc("+(100/cols)+"% - 10px)"; });
  if([3,5,6,7].includes(divisions)){
    children.forEach((el,i)=>{
      if(divisions===3 && i===1) el.style.flex="1 1 calc(50% - 10px)";
      if(divisions===5 && (i===0||i===3)) el.style.flex="1 1 calc(50% - 10px)";
      if(divisions===6 && (i===2||i===5)) el.style.flex="1 1 calc(50% - 10px)";
      if(divisions===7 && (i===1||i===4)) el.style.flex="1 1 calc(50% - 10px)";
    });
  }
}
fullscreenBtn.onclick=()=>{ if(!document.fullscreenElement){ document.documentElement.requestFullscreen?.(); } else { document.exitFullscreen?.(); } };
addEventListener('dblclick', ()=> fullscreenBtn.onclick());

/*************** UI HELPERS ***************/
let sliderInputs=[]; // ordered for Q-row mapping (discrete 0..5)
function vSlider(initial=0, title="Slider", oninput){
  const wrap=document.createElement('div'); wrap.className='vslider'; wrap.title=title;
  const fill=document.createElement('div'); fill.className='fill'; wrap.appendChild(fill);
  // hidden logical <input> keeps min/max
  const input=document.createElement('input'); input.type='range'; input.min=0; input.max=1; input.step=0.001; input.value=initial; input.style.display='none'; wrap.appendChild(input);
  const update=()=>{ const pct=(+input.value)*100; wrap.style.setProperty('--val', pct+'%'); oninput && oninput(+input.value); };
  input.addEventListener('input', update); update();
  wrap.addEventListener('mousedown', (e)=>{ const r=wrap.getBoundingClientRect(); const pct=1 - Math.min(1,Math.max(0,(e.clientY-r.top)/r.height)); input.value=pct; input.dispatchEvent(new Event('input',{bubbles:true})); });
  wrap.addEventListener('touchstart',(e)=>{e.preventDefault(); const t=e.touches[0]; const r=wrap.getBoundingClientRect(); const pct=1 - Math.min(1,Math.max(0,(t.clientY-r.top)/r.height)); input.value=pct; input.dispatchEvent(new Event('input',{bubbles:true})); },{passive:false});
  sliderInputs.push(input);
  return {wrap,input, set(v){input.value=v; update();}};
}
function tweenTo(input, target, ms=300){ const start=+input.value; const d=target-start; const t0=performance.now(); function step(now){ const p=Math.min(1,(now-t0)/ms); input.value=(start+d*p); input.dispatchEvent(new Event('input',{bubbles:true})); if(p<1) requestAnimationFrame(step);} requestAnimationFrame(step); }

/*************** LESSON BUILDERS (trigger‑first) ***************/
function lesson1(){
  const trg=document.createElement('div'); trg.className='trigger'; trg.title='L1 — Space';
  const rack=document.createElement('div'); rack.className='rack'; // empty for L1
  const pad=document.createElement('div'); pad.className='pad';
  let cur=null; function on(){ ensureAudio().then(()=>{ startVU(); if(cur) return; const {src,out}=makeNoise(); out.connect(masterGain); src.start(); cur={src,out}; trg.classList.add('active'); }); }
  function off(){ if(!cur) return; try{cur.src.stop();}catch{} cur.out.disconnect(); cur=null; trg.classList.remove('active'); }
  trg.onmousedown=on; trg.onmouseup=off; trg.onmouseleave=off; trg.ontouchstart=(e)=>{e.preventDefault(); on();}; trg.ontouchend=off;
  addEventListener('keydown', (e)=>{ if(e.code==='Space') on(); }); addEventListener('keyup', (e)=>{ if(e.code==='Space') off(); });
  trg.append(rack,pad); return trg;
}

function lesson2(){
  const group=document.createDocumentFragment();
  // two triggers: A (darker) and S (brighter) — each with its own sliders
  function build(label, brighter){
    const trg=document.createElement('div'); trg.className='trigger'; trg.title = brighter? 'L2 — S (bright)' : 'L2 — A (dark)';
    const rack=document.createElement('div'); rack.className='rack';
    const cutoff=vSlider( brighter? 0.6:0.2, 'Cutoff', ()=>{ if(state.lp) state.lp.frequency.value = 200 + 7800*cutoff.input.value; });
    const res=vSlider(0.0, 'Resonance', ()=>{ if(state.lp) state.lp.Q.value = Math.max(0.0001, res.input.value*20); });
    rack.append(cutoff.wrap,res.wrap);
    const pad=document.createElement('div'); pad.className='pad';
    let state={cur:null, lp:null};
    function on(){ ensureAudio().then(()=>{ startVU(); if(state.cur) return; const {src,out}=makeNoise(); state.lp=biq({type:'lowpass',freq:200+7800*+cutoff.input.value,Q:Math.max(0.0001,res.input.value*20)}); out.connect(state.lp).connect(masterGain); src.start(); state.cur={src,out}; trg.classList.add('active'); }); }
    function off(){ if(!state.cur) return; try{state.cur.src.stop();}catch{} state.cur.out.disconnect(); state.lp?.disconnect(); state={cur:null,lp:null}; trg.classList.remove('active'); }
    trg.onmousedown=on; trg.onmouseup=off; trg.onmouseleave=off; trg.ontouchstart=(e)=>{e.preventDefault(); on();}; trg.ontouchend=off;
    trg.append(rack,pad); return {trg, sliders:[cutoff.input,res.input]};
  }
  const A=build('A',false); const S=build('S',true);
  group.append(A.trg, S.trg);
  return {frag:group, sliders:[...A.sliders, ...S.sliders]};
}

function lesson3(){
  const trg=document.createElement('div'); trg.className='trigger'; trg.title='L3 — D + ADSR';
  const rack=document.createElement('div'); rack.className='rack';
  const A=vSlider(0.02,'Attack'); const D=vSlider(0.2,'Decay'); const S=vSlider(0.6,'Sustain'); const R=vSlider(0.3,'Release'); const C=vSlider(0.5,'LP Cutoff');
  rack.append(A.wrap,D.wrap,S.wrap,R.wrap,C.wrap);
  const pad=document.createElement('div'); pad.className='pad';
  let env, state=null, lp=null;
  function on(){ ensureAudio().then(()=>{ startVU(); if(state) return; const {src,out}=makeNoise(); env=adsr({A:+A.input.value, D:+D.input.value, S:+S.input.value, R:+R.input.value}); lp=biq({type:'lowpass', freq:200+7800*+C.input.value}); out.connect(lp).connect(env.node).connect(masterGain); src.start(); env.on(); state={src,out}; trg.classList.add('active'); }); }
  function off(){ if(!state) return; env.off(); const stopAt=audioCtx.currentTime + +R.input.value + 0.05; state.src.stop(stopAt); setTimeout(()=>{ try{state.out.disconnect(); lp.disconnect();}catch{} state=null; trg.classList.remove('active'); }, (+R.input.value+0.1)*1000); }
  // live updates
  A.input.oninput=()=>{}; D.input.oninput=()=>{}; S.input.oninput=()=>{}; R.input.oninput=()=>{}; C.input.oninput=()=>{ if(lp) lp.frequency.value=200+7800*+C.input.value; };
  trg.onmousedown=on; trg.onmouseup=off; trg.onmouseleave=off; trg.ontouchstart=(e)=>{e.preventDefault(); on();}; trg.ontouchend=off;
  trg.append(rack,pad); return {trg, sliders:[A.input,D.input,S.input,R.input,C.input]};
}

function lesson4(){
  const trg=document.createElement('div'); trg.className='trigger'; trg.title='L4 — F (toggle)';
  const rack=document.createElement('div'); rack.className='rack';
  const rate=vSlider(0.25,'LFO Rate'); const depth=vSlider(0.2,'Depth'); const base=vSlider(0.15,'Base Cutoff');
  rack.append(rate.wrap,depth.wrap,base.wrap);
  const pad=document.createElement('div'); pad.className='pad';
  let state=null, lfoOsc=null, lfoGain=null, lp=null;
  function start(){ ensureAudio().then(()=>{ startVU(); if(state) return; const {src,out}=makeNoise(); lp=biq({type:'lowpass',freq:200+7800*+base.input.value}); lfoOsc=audioCtx.createOscillator(); lfoOsc.type='sine'; lfoOsc.frequency.value=0.1 + 19.9*(+rate.input.value); lfoGain=audioCtx.createGain(); lfoGain.gain.value=50 + 5950*(+depth.input.value); lfoOsc.connect(lfoGain).connect(lp.frequency); out.connect(lp).connect(masterGain); lfoOsc.start(); src.start(); state={src,out}; trg.classList.add('active'); }); }
  function stop(){ if(!state) return; try{state.src.stop(); lfoOsc.stop();}catch{} try{state.out.disconnect(); lp.disconnect(); lfoGain.disconnect();}catch{} state=null; lfoOsc=null; lfoGain=null; lp=null; trg.classList.remove('active'); }
  pad.onmousedown=()=> state?stop():start(); pad.ontouchstart=(e)=>{e.preventDefault(); state?stop():start(); };
  addEventListener('keydown',(e)=>{ if(e.repeat) return; if(e.key.toLowerCase()==='f'){ state?stop():start(); } });
  rate.input.addEventListener('input',()=>{ if(lfoOsc) lfoOsc.frequency.setTargetAtTime(0.1+19.9*(+rate.input.value), audioCtx.currentTime, .02); });
  depth.input.addEventListener('input',()=>{ if(lfoGain) lfoGain.gain.setTargetAtTime(50+5950*(+depth.input.value), audioCtx.currentTime, .02); });
  base.input.addEventListener('input',()=>{ if(lp) lp.frequency.setTargetAtTime(200+7800*(+base.input.value), audioCtx.currentTime, .02); });
  trg.append(rack,pad); return {trg, sliders:[rate.input,depth.input,base.input]};
}

/*************** RENDER ***************/
function render(){
  sliderInputs=[]; grid.innerHTML='';
  for(let i=1;i<=divisions;i++){
    // each division adds one lesson block worth of triggers
    if(i===1){ grid.appendChild(lesson1()); }
    if(i===2){ const L2=lesson2(); grid.appendChild(L2.frag); }
    if(i===3){ const L3=lesson3(); grid.appendChild(L3.trg); }
    if(i===4){ const L4=lesson4(); grid.appendChild(L4.trg); }
    if(i>4){ // repeat pattern
      const L2=lesson2(); const L3=lesson3(); grid.appendChild(L2.frag); grid.appendChild(L3.trg); }
  }
}

/*************** KEYBOARD: divisions & Q‑row (discrete 0..5) ***************/
addEventListener('keydown', (e)=>{
  if(['input','textarea'].includes(document.activeElement?.tagName?.toLowerCase())) return;
  if(e.key==='ArrowLeft'){ setDivisions(divisions-1); }
  if(e.key==='ArrowRight'){ setDivisions(divisions+1); }
});

// Q-row mapping pairs: q/1, w/2, e/3, r/4, t/5, y/6, u/7, i/8
const pairs=[["q","1"],["w","2"],["e","3"],["r","4"],["t","5"],["y","6"],["u","7"],["i","8"]];
addEventListener('keydown', (e)=>{
  const k=e.key.toLowerCase();
  pairs.forEach(([dec,inc],idx)=>{
    const sl=sliderInputs[idx]; if(!sl) return;
    // Quantize to 5 steps (levels 0..5 => 6 positions: 0,20,40,60,80,100). Number 5 => 100%, level 5. Level 0 => 0%.
    const levelFromVal=(v)=> Math.round((+v)*5);
    const valFromLevel=(L)=> Math.max(0,Math.min(5,L))/5;
    let L=levelFromVal(sl.value);
    if(k===dec){ L = Math.max(0, L-1); tweenTo(sl, valFromLevel(L), 300); }
    if(k===inc){ L = Math.min(5, L+1); tweenTo(sl, valFromLevel(L), 300); }
  });
});

// Boot
setDivisions(divisions);
</script>
</body>
</html>
